<div class="container mt-3">
  <!-- Overlay de éxito/error -->
  <div 
    v-if="mensaje" 
    class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center"
    style="background: rgba(0,0,0,0.5); z-index: 2000;"
  >
    <div class="bg-white rounded-4 shadow-lg p-5 text-center" style="max-width: 400px;">
      <div v-if="mensajeTipo === 'success'" class="text-success">
        <i class="bi bi-check-circle-fill display-1"></i>
      </div>
      <div v-if="mensajeTipo === 'error'" class="text-danger">
        <i class="bi bi-x-circle-fill display-1"></i>
      </div>
      <p class="mt-3 fs-4 fw-bold">{{ mensaje }}</p>
    </div>
  </div>

  <!-- Encabezado -->
  <div class="bg-light border rounded-4 shadow-sm py-3 px-4 mb-4">
    <h2 class="text-center mb-0 fw-bold mt-5">
      <i class="bi bi-book-half me-2 text-primary"></i> Lista de Libros
    </h2>
  </div>

  <!-- Buscar + Crear -->
  <div class="row mb-3">
    <div class="col-12 col-md-4 mb-2">
      <input 
        type="text" 
        class="form-control" 
        placeholder="Buscar" 
        v-model="busqueda"
      >
    </div>
    <div class="col-12 col-md-8 d-flex justify-content-end align-items-center">
      <button class="btn btn-success" @click="abrirCrearLibro">
        <i class="bi bi-plus-circle me-2"></i> Crear libro
      </button>
    </div>
  </div>

  <!-- Tarjetas de libros -->
  <div class="row g-4 mt-2">
    <div 
      class="col-12 col-sm-6 col-md-4 col-lg-3" 
      v-for="libro in librosFiltrados" 
      :key="libro.libro_id"
    >
      <div 
          class="card h-100 shadow-lg rounded-4 border-0 card-hover" 
          :class="libro.estado_id === 2 ? 'bg-danger-subtle text-dark' : 'bg-light'" 
          @click="verLibro(libro.libro_id)" 
          style="cursor:pointer;"
        >
        <div class="card-body d-flex flex-column justify-content-center align-items-center p-4">
          <i class="bi bi-book-half display-3 text-primary mb-3"></i>
          <h4 class="card-title text-center fw-bold mb-2">{{ libro.titulo }}</h4>
          <hr class="w-50 my-2">
          <p class="card-text mb-1 text-center">
            <span class="fw-semibold text-secondary">Autor:</span> {{ nombreAutor(libro.autor_id) }}
          </p>
          <p class="card-text mb-1 text-center">
            <span class="fw-semibold text-secondary">Editorial:</span> {{ nombreEditorial(libro.editorial_id) }}
          </p>
          <p class="card-text mb-1 text-center">
            <span class="fw-semibold text-secondary">Género:</span> {{ nombreGenero(libro.genero_id) }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Crear/Editar Libro -->
  <div 
    class="modal fade show" 
    tabindex="-1" 
    style="display: block; background: rgba(0,0,0,0.5);" 
    v-if="mostrarModalCrear"
  >
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-book-half me-2"></i> {{ editando ? 'Editar Libro' : 'Crear Libro' }}
          </h5>
          <button type="button" class="btn-close" @click="cerrarCrearLibro"></button>
        </div>

        <form @submit.prevent="editando ? actualizarLibro() : crearLibro()">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Título</label>
              <input v-model="libroForm.titulo" type="text" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Fecha de publicación</label>
              <input v-model="libroForm.fecha_publicacion" type="date" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Autor</label>
              <select v-model="libroForm.autor_id" class="form-select" required>
                <option 
                  v-for="autor in autores" 
                  :key="autor.autor_id" 
                  :value="autor.autor_id"
                >
                  {{ autor.nombre }} {{ autor.apellido }}
                </option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Editorial</label>
              <select v-model="libroForm.editorial_id" class="form-select" required>
                <option 
                  v-for="editorial in editoriales" 
                  :key="editorial.editorial_id" 
                  :value="editorial.editorial_id"
                >
                  {{ editorial.nombre }}
                </option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Género</label>
              <select v-model="libroForm.genero_id" class="form-select" required>
                <option 
                  v-for="genero in generos" 
                  :key="genero.genero_id" 
                  :value="genero.genero_id"
                >
                  {{ genero.nombre }}
                </option>
              </select>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-success">
              {{ editando ? 'Actualizar' : 'Crear' }}
            </button>
            <button type="button" class="btn btn-secondary" @click="cerrarCrearLibro">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Modal Ver Detalle -->
  <div class="modal fade show" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);" v-if="mostrarModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-book-half me-2"></i> {{ libroSeleccionado?.titulo || 'Cargando...' }}
          </h5>
          <button type="button" class="btn-close" @click="cerrarModal"></button>
        </div>

        <!-- Detalles del libro -->
        <div class="modal-body" v-if="libroSeleccionado">
          <p><strong>Id:</strong> {{ libroSeleccionado.libro_id }}</p>
          <p><strong>Autor:</strong> {{ nombreAutor(libroSeleccionado.autor_id) }}</p>
          <p><strong>Editorial:</strong> {{ nombreEditorial(libroSeleccionado.editorial_id) }}</p>
          <p><strong>Género:</strong> {{ nombreGenero(libroSeleccionado.genero_id) }}</p>

          <!-- Estado: en rojo si es 2 -->
          <p>
            <strong>Estado: </strong> 
            <span :class="libroSeleccionado.estado_id === 1 ? 'text-success fw-bold' : ''">
            <span :class="libroSeleccionado.estado_id === 2 ? 'text-danger fw-bold' : ''">
              {{ nombreEstado(libroSeleccionado.estado_id) }}
            </span>
            </span>
          </p>

          <p><strong>Año de publicación:</strong> {{ formatearFecha(libroSeleccionado.fecha_publicacion) }}</p>
        </div>

        <!-- Spinner si está cargando -->
        <div class="modal-body text-center" v-else>
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>

        <!-- Footer con botones -->
        <div class="modal-footer">
          <!-- Si estado_id === 2, solo botón devolver -->
          <button 
            v-if="libroSeleccionado?.estado_id === 2" 
            type="button" 
            class="btn btn-warning" 
            @click="devolverLibro(libroSeleccionado.libro_id)">
            Devolver
          </button>

          <!-- Si no está prestado (estado distinto de 2), mostrar todos -->
          <template v-else>
            <button type="button" class="btn btn-primary" @click="abrirEdicion(libroSeleccionado)">Editar</button>
            <button type="button" class="btn btn-success" @click="prestarModal">Solicitar</button>
            <button type="button" class="btn btn-danger" @click="eliminarLibro(libroSeleccionado.libro_id)">Eliminar</button>
          </template>
        </div>
      </div>
    </div>
  </div>
</div>
